function ORGFloorMap(e,t,i,o){var s=i,n=null;n=new THREE.Scene;var r=document.createElement("iframe");r.src="simple-map.html";r.style.width="2000px",r.style.height="2000px";var a=new THREE.CSS3DObject(r);a.position.x=e.position.x,a.position.y=e.position.y,a.position.z=e.position.z,a.rotation.x=-Math.PI/2,a.rotation.y=e.rotation.y,a.rotation.z=e.rotation.z,a.scale.x=2,a.scale.y=2,n.add(a);var l=new THREE.CSS3DRenderer;l.setSize(t.getSize().width,t.getSize().height),l.domElement.style.position="absolute",l.domElement.style.top=0,l.domElement.style.margin=0,l.domElement.style.padding=0,l.domElement.style.zIndex=0,o.appendChild(l.domElement),l.domElement.appendChild(t.domElement),THREEx.WindowResize(l,s,o),this.render=function(){l.render(n,s)}}function ORGTestApp(e){this.version=null,this.bundleIdentifier=null,this.name=null,e&&(this.name=e.name,this.version=e.version,this.bundleIdentifier=e.bundleIdentifier)}function sortTreeNodes(e){for(var t=[],i=0;i<e.length;i++){var o=e[i];"class"===o.getField()?t.unshift(o):t.push(o)}return t}function formatNode(e){var t=e.getField();if("screenshot"==t)return null;if("ignore"==t)return null;if("object"==e.type){if(e.dom.value&&e.dom.field)for(var i=0;i<e.childs.length;i++){var o=e.childs[i];if("class"==o.field){e.dom.value.innerHTML="",e.dom.field.innerHTML=o.value;break}}}else"array"==e.type&&e.dom.value&&(e.dom.value.innerHTML="");return e}function cSnapToRoute(){this.routePoints=Array(),this.routePixels=Array(),this.routeOverlay=null,this.normalProj=G_NORMAL_MAP.getProjection(),this.init=function(e,t,i){this._oMap=e,this._oMarker=t,this._oPolyline=i,this.loadRouteData(),this.loadMapListener()},this.updateTargets=function(e,t){this._oMarker=e||this._oMarker,this._oPolyline=t||this._oPolyline,this.loadRouteData()},this.loadMapListener=function(){var e=this;GEvent.addListener(e._oMap,"mousemove",GEvent.callback(e,e.updateMarkerLocation)),GEvent.addListener(e._oMap,"zoomend",GEvent.callback(e,e.loadRouteData))},this.loadRouteData=function(){var e=this._oMap.getZoom();this.routePixels=new Array;for(var t=0;t<this._oPolyline.getVertexCount();t++){var i=this.normalProj.fromLatLngToPixel(this._oPolyline.getVertex(t),e);this.routePixels.push(i)}},this.updateMarkerLocation=function(e){var t=this.getClosestLatLng(e);this._oMarker.setPoint(t)},this.getClosestLatLng=function(e){var t=this.distanceToLines(e);return this.normalProj.fromPixelToLatLng(new GPoint(t.x,t.y),this._oMap.getZoom())},this.getDistAlongRoute=function(e){var t=this.distanceToLines(e);return this.getDistToLine(t.i,t.fTo)},this.distanceToLines=function(e){var t=this._oMap.getZoom();return getClosestPointOnLines(this.normalProj.fromLatLngToPixel(e,t),this.routePixels)},this.getDistToLine=function(e,t){for(var i=this._oPolyline,o=0,s=1;s<e;s++)o+=i.getVertex(s-1).distanceFrom(i.getVertex(s));return o+=i.getVertex(e-1).distanceFrom(i.getVertex(e))*t}}function getClosestPointOnLines(e,t){var i,o,s,n,r,a,l;if(t.length>1){for(var h=1;h<t.length;h++){if(t[h].x!=t[h-1].x){var c=(t[h].y-t[h-1].y)/(t[h].x-t[h-1].x),d=t[h].y-c*t[h].x;l=Math.abs(c*e.x+d-e.y)/Math.sqrt(c*c+1)}else l=Math.abs(e.x-t[h].x);var u=Math.pow(t[h].y-t[h-1].y,2)+Math.pow(t[h].x-t[h-1].x,2),_=Math.pow(t[h].y-e.y,2)+Math.pow(t[h].x-e.x,2),p=Math.pow(t[h-1].y-e.y,2)+Math.pow(t[h-1].x-e.x,2),g=Math.pow(l,2),m=_-g+p-g;m>u&&(l=Math.sqrt(Math.min(_,p))),(null==i||i>l)&&(m>u?p<_?(o=0,s=1):(s=0,o=1):(o=Math.sqrt(p-g)/Math.sqrt(u),s=Math.sqrt(_-g)/Math.sqrt(u)),i=l,a=h)}var v=t[a-1].x-t[a].x,R=t[a-1].y-t[a].y;n=t[a-1].x-v*o,r=t[a-1].y-R*o}return{x:n,y:r,i:a,fTo:o,fFrom:s}}var ORG=ORG||{};ORG.UI={};class ORGWebSocket{constructor(){this._ws=null,this._serverURL=null,this._delegate=null}open(e,t){let i=this;this._serverURL=e,this._delegate=t;let o="ws://"+this._serverURL+"/main";this._ws=new WebSocket(o),this._ws.onopen=function(){i.onOpen()},this._ws.onclose=function(){i.onClose(event)},this._ws.onmessage=function(e){i.onMessage(e)},this._ws.onerror=function(e){i.onError(e)}}close(){this._ws?this._ws.close():console.log("CLOSE requested but there is no ws.")}send(e){this._ws&&this._ws.send(e)}isConnected(){return!!this._ws}getServerURL(){return this._serverURL}onOpen(){console.log("OPENED: "+this._serverURL),this._delegate.onOpen&&this._delegate.onOpen(this)}onClose(e){console.log("CLOSED: "+this._serverURL),this._ws=null,this._delegate.onClose&&this._delegate.onClose(e,this)}onMessage(e){this._delegate.onMessage&&this._delegate.onMessage(e,this)}onError(e){console.log("WS Error: "+JSON.stringify(e)),this._delegate.onError&&this._delegate.onError(e,this)}}const ORGTreeVisualizationMask={ShowNormalWindow:1,ShowAlertWindow:2,ShowKeyboardWindow:4,ShowStatusWindow:8,ShowScreenshots:16,ShowPrivate:32,ShowPublic:64,ShowHiddenViews:128,ShowHiddenViewsOnly:256,ShowInteractiveViews:512,ShowNonInteractiveViews:1024,ShowOutOfScreen:2048},kORGPlaneDistance=10,kORGExtrudeDuration=500;class ORGUITreeModel{constructor(e){this._treeData=null,this._threeElementTreeGroup=null,this._screenSize=null,this._threeScene=null,this._collapseTweenCount=0,this._visualizationFlags=e}get treeGroup(){return this._threeElementTreeGroup}set visualizationFlags(e){this._visualizationFlags=e}createUITreeModel(e,t,i){this._collapseTweenCount=0,this._screenSize=i,this._treeData=e,this._threeScene=t,this._createUITreeModel(this._treeData,this._threeScene,this._screenSize)}updateUITreeModel(e,t,i,o){this._treeData&&this.removeUITreeModel(t),this.createUITreeModel(e,t,o)}collapseWithCompletion(e){for(let t=0;t<this._treeData.length;t++){const i=this._treeData[t];this._collapseNodeAnimatedWithCompletion(i,e)}}removeUITreeModel(e){this._threeElementTreeGroup&&(e.remove(this._threeElementTreeGroup),this._threeElementTreeGroup=null)}hideTextures(e){this._threeElementTreeGroup&&this._threeElementTreeGroup.traverse(function(t){t instanceof THREE.Mesh&&(e?(t.material.map=null,t.material.color=new THREE.Color(0)):(t.material.map=t.ORGData.threeScreenshotTexture,t.material.color=new THREE.Color(16777215)),t.material.needsUpdate=!0)})}hideNonInteractiveViews(e){this._threeElementTreeGroup&&this._threeElementTreeGroup.traverse(function(t){if(t instanceof THREE.Group)if(e){const e=t.userData;e&&(_nodeIsInteractive(e)||_hideNodeGroup(t,!0))}else _hideNodeGroup(t,!1)})}showConnections(e,t){this._threeElementTreeGroup&&this._threeElementTreeGroup.traverse(function(e){if(e instanceof THREE.Group){const i=e.userData;if(_nodeIsInteractive(i)){const i=e.children[0];if(i){const e=new THREE.ArrowHelper(new THREE.Vector3(1,0,0),i.position,400,255,50,25);e.cone;t.add(e)}}}})}_createUITreeModel(e,t,i){this.removeUITreeModel(t),this._threeElementTreeGroup=new THREE.Group;this._createTree3DModel(e,this._treeData,i,0),t.add(this._threeElementTreeGroup)}_createTree3DModel(e,t,i,o){if(e)for(let s=0;s<e.length;s++){const n=e[s];if(this._mustCreateTreeBranch(n)){let e=o;this._mustCreateTreeObject(n)&&(this._createTreeNode3DModel(n,t,i,o),n.zPosition&&(e=n.zPosition)),n.subviews&&this._createTree3DModel(n.subviews,[n],i,e)}else console.log("ignoring tree branch.")}}_createTreeNode3DModel(e,t,i,o){if("object"!=typeof e)return void console.log("what is this ? Tree node that is not an object ?");let s=null,n=e.screenshot;if(n){let e=new Image;e.src="data:image/png;base64,"+n,(s=new THREE.Texture(e)).minFilter=THREE.NearestFilter,s.needsUpdate=!0}const r=this._calculateElementZPosition(e,t,o,i);let a=this._createUIObject(e,s,i,r);if(a)if(this._threeElementTreeGroup.add(a),e.threeObj=a,a.userData=e,this._mustHideTreeObject(e))a.visible=!1;else{const t={x:a.position.x,y:a.position.y,z:e.zPosition};new TWEEN.Tween(a.position).to(t,kORGExtrudeDuration).start()}}_createUIObject(e,t,i,o){var s,n,r,a,l,h,c,d;if(!e.bounds)return null;var u=new THREE.Group;return a=e.bounds.right-e.bounds.left,l=e.bounds.bottom-e.bounds.top,h=e.bounds.left,c=e.bounds.top,s=new THREE.PlaneBufferGeometry(a,l,1,1),e.zPosition=o,d=new THREE.Vector3(-(i.width/2-h-a/2),i.height/2-c-l/2,0),n=this._flagShowScreenshots&&t?new THREE.MeshBasicMaterial({map:t,transparent:!1,side:THREE.DoubleSide}):new THREE.MeshBasicMaterial({color:0,side:THREE.DoubleSide,transparent:!1}),(r=new THREE.Mesh(s,n)).position.set(d.x,d.y,d.z),r.ORGData={threeScreenshotTexture:t},u.add(r),u.add(new THREE.BoxHelper(r,16777215)),u}_collapseNodeAnimatedWithCompletion(e,t){var i=e.threeObj;if(i){const o=this;new TWEEN.Tween(i.position).to({x:i.position.x,y:i.position.y,z:0},kORGExtrudeDuration).onStart(function(){o._collapseTweenCount++}).onComplete(function(){o._hideNodeGroup(i,!0),e.zPosition=0,--o._collapseTweenCount<=0&&(o._collapseTweenCount=0,o._threeElementTreeGroup&&(o._threeScene.remove(o._threeElementTreeGroup),o._threeElementTreeGroup=null),t&&t())}).start()}if(e.subviews){const i=e.subviews;for(let e=0;e<i.length;e++){const o=i[e];this._collapseNodeAnimatedWithCompletion(o,t)}}}_modelVisualizationChanged(){if(this._threeElementTreeGroup){const e=this;this._threeElementTreeGroup.traverse(function(t){if(t instanceof THREE.Group){var i=t.userData;i&&this._hideNodeGroup(t,e._mustHideTreeObject(i))}})}}_changeOpacity(e,t){if(e)for(let o=0;o<e.length;o++){const s=e[o];if(s&&"object"==typeof s){var i=s.threeObj;if(i){if("UITextEffectsWindow"==s.class)continue;if(1==s.private)continue;i.material.opacity=t,i.needsUpdate=!0}this._changeOpacity(e[o].subviews,t)}}}_mustDrawTreeObjectAsCube(e,t){return!(!t||!(e.bounds.left>t.bounds.left||e.bounds.top>t.bounds.top||e.bounds.right<t.bounds.right||e.bounds.bottom<t.bounds.bottom))}_mustHideTreeObject(e){return!(!e.hidden||this._flagShowHiddenViews)||(!(0!=e.hidden||!this.flagShowHiddenViewsOnly)||(this._nodeIsInteractive(e)?!this._flagShowInteractiveViews:!this._flagShowNonInteractiveViews))}_mustCreateTreeBranch(e){return!(this._isKeyboardWindow(e)&&!this._flagShowKeyboard)}_mustCreateTreeObject(e){return!(!this._flagShowPrivate&&e.private&&1==e.private)&&(!(!this._flagShowOutOfScreen&&this._treeObjectIsOutOfScreen(e,deviceScreenSize))&&!this._isStatusBarWindow(e))}_removeScreenshotFromScreen(){screenPlane.material.color=0}_calculateElementZPosition(e,t,i,o){if(!e||!t)return i;let s=i;const n=e.bounds;for(let i=0;i<t.length;i++){const r=t[i].threeObj;if(e!=t[i]&&r){const e=r.children[0];e.geometry.computeBoundingBox();const a={left:e.geometry.boundingBox.min.x+e.position.x+o.width/2,top:Math.abs(e.geometry.boundingBox.max.y+e.position.y-o.height/2),right:e.geometry.boundingBox.max.x+e.position.x+o.width/2,bottom:Math.abs(e.geometry.boundingBox.min.y+e.position.y-o.height/2)};if(n&&a&&this._rectsIntersect(n,a)){const e=t[i].zPosition;e>=s&&(s=e+kORGPlaneDistance)}}s=this._calculateElementZPosition(e,t[i].subviews,s,o)}return s}_rectsIntersect(e,t){return e.left<t.right&&t.left<e.right&&e.top<t.bottom&&t.top<e.bottom}_treeObjectIsOutOfScreen(e,t){return e.bounds.top>t.height}_nodeIsInteractive(e){return!!e.gestures||(!!e.controlEvents||(!("UITextField"!=e.class||!e.userInteractionEnabled)||(!("MKMapView"!=e.class||!e.userInteractionEnabled)||(!("_MKUserTrackingButton"!=e.class||!e.userInteractionEnabled)||void 0))))}_hideNodeGroup(e,t){var i=e.children[0];i&&(i.visible=!t);var o=e.children[1];o&&(o.visible=!t)}_isStatusBarWindow(e){return"UIAWindow"==e.nativeClass&&"UIAStatusBar"==e.subviews[0].nativeClass}_isKeyboardWindow(e){return"UITextEffectsWindow"==e.class}get _flagShowKeyboard(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowKeyboardWindow}get _flagShowPrivate(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowPrivate}get _flagShowHiddenViews(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowHiddenViews}get _flagShowHiddenViewsOnly(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowHiddenViewsOnly}get _flagShowOutOfScreen(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowOutOfScreen}get _flagShowInteractiveViews(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowInteractiveViews}get _flagShowNonInteractiveViews(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowNonInteractiveViews}get _flagShowScreenshots(){return this._visualizationFlags&ORGTreeVisualizationMask.ShowScreenshots}}class ORGMouseListener{constructor(e){this._domElement=e,this._listeners=[]}enable(){var e=this;$(this._domElement).bind("mousedown",function(t){for(var i=0;i<e._listeners.length;i++)e._listeners[i].onMouseDown&&e._listeners[i].onMouseDown(t)}),$(this._domElement).bind("mouseup",function(t){for(var i=0;i<e._listeners.length;i++)e._listeners[i].onMouseUp&&e._listeners[i].onMouseUp(t)}),$(this._domElement).bind("mousemove",function(t){for(var i=0;i<e._listeners.length;i++)e._listeners[i].onMouseMove&&e._listeners[i].onMouseMove(t)}),$(this._domElement).bind("contextmenu",function(t){t.preventDefault();for(var i=0;i<e._listeners.length;i++)e._listeners[i].onContextMenu&&e._listeners[i].onContextMenu(t)})}disable(){$(this._domElement).unbind()}addDelegate(e){this._listeners.push(e)}removeDelegate(e){for(var t=0;t<this._listeners.length;t++)this._listeners[t]==e&&this._listeners.splice(t,0)}}class ORG3DUIElementHiliter{constructor(){this._hilitedObj=null}mouseOverElement(e){if(e){var t=!1;this._hilitedObj?this._hilitedObj.id!=e.id&&(this._highlightUIElement(this._hilitedObj,!1),t=!0):t=!0,t&&this._highlightUIElement(e,!0)}else this._hilitedObj&&this._highlightUIElement(this._hilitedObj,!1)}_highlightUIElement(e,t){if(e&&("PlaneBufferGeometry"==e.geometry.type||"BoxGeometry"==e.geometry.type)){var i=e.parent;if(i)for(var o in i.children)if(i.children[o]instanceof THREE.BoxHelper){var s=i.children[o];s.material.color.set(t?16711680:16777215),s.material.needsUpdate=!0,this._hilitedObj=t?e:null;break}}}}class ORGTooltip{constructor(e){this._threeCanvasDomElement=e,this._hilitedObj=null,this._tooltipOpen=!1,$(this._threeCanvasDomElement).uitooltip({items:$(this._threeCanvasDomElement),content:"Roll over element",track:!0,open:function(e,t){console.log(t)},create:function(e,t){console.log(t)}}),this._tooltipOpen=!0}destroy(){this._threeCanvasDomElement&&$(this._threeCanvasDomElement).uitooltip("destroy")}mouseOverElement(e){if(e){var t=!1;this._hilitedObj?this._hilitedObj.id!=e.id&&(t=!0):t=!0,t&&(console.log(e.parent.userData.class),this._show(e.parent.userData))}else this._tooltipOpen&&$(this._threeCanvasDomElement).uitooltip("option","content","<span class='ui-tooltip-value'>Roll over element</span>")}_show(e){this._tooltipOpen&&($(this._threeCanvasDomElement).uitooltip("option","content",this._createTooltipContent(e)),$(this._threeCanvasDomElement).uitooltip("enable"))}_hide(){this._tooltipOpen&&($(this._threeCanvasDomElement).uitooltip("destroy"),this._tooltipOpen=!1)}_createTooltipContent(e){if(!e)return"";var t="<div>"+e.class;for(var i in e)"screenshot"!=i&&"class"!=i&&"subviews"!=i&&"threeObj"!=i&&"layerZPosition"!=i&&"zPosition"!=i&&(t+="accessibility"!=i?"bounds"!=i?"gestures"!=i?"segues"!=i?"controlEvents"!=i?"targets"!=i?"<br><span class='ui-tooltip-key'>"+i+": </span><span class='ui-tooltip-value'>"+e[i]+"</span>":"<br><span class='ui-tooltip-key'>targets: </span><span class='ui-tooltip-value'>"+this._serializeStrings(e[i])+"</span>":"<br><span class='ui-tooltip-key'>controlEvents: </span><span class='ui-tooltip-value'>"+this._serializeStrings(e[i])+"</span>":"<br><span class='ui-tooltip-key'>segues: </span><span class='ui-tooltip-value'>"+this._serializeSegues(e[i])+"</span>":"<br><span class='ui-tooltip-key'>gestures: </span><span class='ui-tooltip-value'>"+this._serializeGestures(e[i])+"</span>":"<br><span class='ui-tooltip-key'>bounds: </span><span class='ui-tooltip-value'>"+this._serializeBounds(e[i])+"</span>":this._serializeDictionary(e[i]));return t+="</div>"}_serializeDictionary(e){var t="";for(var i in e)t+="<br><span class='ui-tooltip-key'>"+i+": </span><span class='ui-tooltip-value'>"+e[i]+"</span>";return t}_serializeBounds(e){return"x:"+e.left+" y:"+e.top.toString()+" w:"+(e.right-e.left).toString()+" h:"+(e.bottom-e.top).toString()}_serializeGestures(e){for(var t="",i=0;i<e.length;i++)t+=this._serializeGesture(e[i]);return t}_serializeGesture(e){var t="";for(var i in e)t.length&&(t+=", "),t+=i+":"+e[i];return"["+t+"]"}_serializeSegues(e){for(var t="",i=0;i<e.length;i++)t+=this._serializeSegue(e[i]);return t}_serializeSegue(e){var t="";for(var i in e)t.length&&(t+=", "),t+=i+":"+e[i];return"["+t+"]"}_serializeStrings(e){for(var t="",i=0;i<e.length;i++)t+=(t.length?", ":"")+e[i];return t}}const ORGSceneVisualizationMask={ShowFloor:1,ShowDevice:2,ShowTooltips:4,ShowLocation:8,ContinuousUpdate:16},kORGCameraTWEENDuration=600,kORGFloorPositionY=-450;class ORG3DScene{constructor(e,t){this._sceneFloor=null,this._deviceScreen=null,this._uiTreeModelRaycaster=null,this._screenRaycaster=null,this._mouseListener=null,this._device3DModel=null,this._tooltiper=null,this._threeScene=null,this._threeCamera=null,this._threeRenderer=null,this._threeOrbitControls=null,this._keyboardState=null,this._threeClock=null,this._screenshotImage=null,this._screenshotNeedsUpdate=!1,this._deviceScreenSize=null,this._uiExpanded=!1,this._canvasDomElement=null,this._threeRendererDOMElement=null,this._contextMenuManager=null,this._locationMarker=null,this._lastLocationName="?",this._transformControl=null,this._sceneVisualFlags=ORGSceneVisualizationMask.ShowFloor|ORGSceneVisualizationMask.ShowDevice|ORGSceneVisualizationMask.ShowLocation|ORGSceneVisualizationMask.ContinuousUpdate,this._treeVisualizationFlags=ORGTreeVisualizationMask.ShowNormalWindow|ORGTreeVisualizationMask.ShowAlertWindow|ORGTreeVisualizationMask.ShowKeyboardWindow|ORGTreeVisualizationMask.ShowOutOfScreen|ORGTreeVisualizationMask.ShowInteractiveViews|ORGTreeVisualizationMask.ShowNonInteractiveViews|ORGTreeVisualizationMask.ShowScreenshots,this._uiTreeModel=new ORGUITreeModel(this._treeVisualizationFlags),this._initialize(e,this.flagShowFloor)}get isExpanded(){return this._uiExpanded}get deviceScreenBoundingBox(){return this._deviceScreen.boundingBox}get flagContinuousScreenshot(){return this._sceneVisualFlags&ORGSceneVisualizationMask.ContinuousUpdate}set flagContinuousScreenshot(e){e?this._sceneVisualFlags|=ORGSceneVisualizationMask.ContinuousUpdate:this._sceneVisualFlags&=~ORGSceneVisualizationMask.ContinuousUpdate}get flagShowTooltips(){return this._sceneVisualFlags&ORGSceneVisualizationMask.ShowTooltips}set flagShowTooltips(e){e?this._sceneVisualFlags|=ORGSceneVisualizationMask.ShowTooltips:this._sceneVisualFlags&=~ORGSceneVisualizationMask.ShowTooltips}get flagShowDevice3DModel(){return this._sceneVisualFlags&ORGSceneVisualizationMask.ShowDevice}get flagShowFloor(){return this._sceneVisualFlags&ORGSceneVisualizationMask.ShowFloor}set flagShowFloor(e){e?this._sceneVisualFlags|=ORGSceneVisualizationMask.ShowFloor:this._sceneVisualFlags&=~ORGSceneVisualizationMask.ShowFloor}get flagShowLocation(){return this._sceneVisualFlags&ORGSceneVisualizationMask.ShowLocation}set flagShowLocation(e){e?this._sceneVisualFlags|=ORGSceneVisualizationMask.ShowLocation:this._sceneVisualFlags&=~ORGSceneVisualizationMask.ShowLocation}get flagShowPrivateClasses(){return this._treeVisualizationFlags&ORGTreeVisualizationMask.ShowPrivate}set flagShowPrivateClasses(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowPrivate:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowPrivate}set flagShowKeyboardWindow(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowKeyboardWindow:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowKeyboardWindow}set flagShowHiddenViews(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowHiddenViews:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowHiddenViews}set flagShowNonInteractiveViews(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowNonInteractiveViews:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowNonInteractiveViews}set flagShowInteractiveViews(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowInteractiveViews:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowInteractiveViews}set flagShowScreenshots(e){e?this._treeVisualizationFlags|=ORGTreeVisualizationMask.ShowScreenshots:this._treeVisualizationFlags&=~ORGTreeVisualizationMask.ShowScreenshots}handleDeviceDisconnection(){this.removeDeviceScreen(),this.removeUITreeModel(),this.hideDevice3DModel()}setScreenshotImage(e){this._screenshotImage=e,this._screenshotNeedsUpdate=!0}updateUITreeModel(e){this.removeRaycasterForDeviceScreen(),this.hideDeviceScreen(),this.flagShowTooltips&&this.disableTooltips(),this.destroyRaycasterFor3DTreeModel(),this._uiExpanded=!0,this._uiTreeModel.updateUITreeModel(e,this._threeScene,this._screenshotImage,this._deviceScreenSize),this.createRaycasterFor3DTreeModel(),this.flagShowTooltips&&this.enableTooltips()}removeUITreeModel(){this._uiTreeModel.removeUITreeModel(this._threeScene)}createDeviceScreen(e,t,i){this._deviceScreenSize={width:e,height:t},this._deviceScreen=new ORG3DDeviceScreen(e,t,i,this._threeScene)}removeDeviceScreen(){this._deviceScreen&&(this.removeRaycasterForDeviceScreen(),this._deviceScreen.destroy(),this._deviceScreen=null)}setDeviceOrientation(e,t,i){this._uiExpanded&&this._uiTreeModel&&(this._uiTreeModel.removeUITreeModel(this._threeScene),this._uiExpanded=!1,ORG.UI.buttonExpand.text("Expand")),this._deviceScreen&&(this.removeDeviceScreen(),this.createDeviceScreen(t,i,0),this.createRaycasterForDeviceScreen()),this._device3DModel&&this._device3DModel.setOrientation(e),this.devicePositionHasChanged()}setDeviceScreenSize(e,t){this._deviceScreen&&(this.removeDeviceScreen(),this.createDeviceScreen(e,t,0),this.devicePositionHasChanged(),this.createRaycasterForDeviceScreen())}hideDeviceScreen(){this._deviceScreen&&this._deviceScreen.hide()}showDeviceScreen(){this._deviceScreen&&this._deviceScreen.show()}createRaycasterFor3DTreeModel(){this._uiTreeModelRaycaster=new ORG3DRaycaster(this._threeRendererDOMElement,this._threeCamera,this._uiTreeModel.treeGroup),this._uiTreeModelRaycaster.addDelegate(new ORG3DUIElementHiliter),this._uiTreeModelRaycaster.addDelegate(this._contextMenuManager),this._mouseListener&&(this._mouseListener.addDelegate(this._uiTreeModelRaycaster),this._mouseListener.enable())}destroyRaycasterFor3DTreeModel(){this._uiTreeModelRaycaster&&(this._tooltiper&&this._uiTreeModelRaycaster.removeDelegate(this._tooltiper),this._mouseListener&&this._mouseListener.removeDelegate(this._uiTreeModelRaycaster),this._uiTreeModelRaycaster=null)}createRaycasterForDeviceScreen(){this._screenRaycaster=new ORG3DRaycaster(this._threeRendererDOMElement,this._threeCamera,this._deviceScreen.screenPlane),this._screenRaycaster.addDelegate(this._contextMenuManager),this._mouseListener.addDelegate(this._screenRaycaster),this._mouseListener.enable()}removeRaycasterForDeviceScreen(){this._mouseListener.disable(),this._mouseListener.removeDelegate(this._screenRaycaster),this._screenRaycaster=null}setLiveScreen(e){this.flagContinuousScreenshot=e,this._deviceScreen&&this._sceneVisualFlags&ORGSceneVisualizationMask.ContinuousUpdate&&!this._uiExpanded&&ORG.deviceController.requestScreenshot()}showTooltips(e){this.flagShowTooltips=e,e?this.enableTooltips():this.disableTooltips()}enableTooltips(){this._tooltiper||(this._tooltiper=new ORGTooltip(this._threeRendererDOMElement),this._uiTreeModelRaycaster&&this._uiTreeModelRaycaster.addDelegate(this._tooltiper))}disableTooltips(){this._tooltiper&&(this._uiTreeModelRaycaster&&this._uiTreeModelRaycaster.removeDelegate(this._tooltiper),this._tooltiper.destroy(),this._tooltiper=null)}createFloor(){this._sceneFloor||(this._sceneFloor=this._createFloor(this._threeScene),this.devicePositionHasChanged())}removeFloor(){this._sceneFloor&&this._removeFloor()}expand(){this._uiExpanded||ORG.deviceController.requestElementTree({"status-bar":!0,keyboard:!0,alert:!0,normal:!0})}collapseAndExpandAnimated(){const e=this;this.collapse(function(){e.expand()})}collapse(e){if(this._uiExpanded){this._mouseListener.disable(),this.disableTooltips();const t=this,i=this.flagContinuousScreenshot;this._uiTreeModel.collapseWithCompletion(function(){t._deviceScreen&&t._deviceScreen.show(),i&&ORG.deviceController.requestScreenshot(),t.createRaycasterForDeviceScreen(),t._uiExpanded=!1,e&&e()})}}rotateDevice(){if(this._transformControl)this._threeScene.remove(this._transformControl),this._transformControl=null;else{const e=this;this._transformControl=new THREE.TransformControls(this._threeCamera,this._threeRenderer.domElement),this._transformControl.setMode("rotate"),this._transformControl.addEventListener("change",function(){e._transformControlChanged()}),this._transformControl.attach(this._deviceScreen.screenPlane),this._threeScene.add(this._transformControl)}}resetCameraPosition(){const e=this.flagContinuousScreenshot;e&&this.setLiveScreen(!1);const t=this;new TWEEN.Tween(this._threeCamera.position).to({x:0,y:0,z:900},kORGCameraTWEENDuration).easing(TWEEN.Easing.Quadratic.InOut).onComplete(function(){e&&t.setLiveScreen(!0)}).start(),new TWEEN.Tween(t._threeOrbitControls.target).to({x:0,y:0,z:0},kORGCameraTWEENDuration).easing(TWEEN.Easing.Quadratic.InOut).start()}resetDevicePosition(){const e=this._transformControl.object;if(this._deviceScreen&&this._deviceScreen.screenPlane.rotation.set(0,0,0),this._device3DModel){var t=(new THREE.Box3).setFromObject(this._device3DModel.THREEObject).getCenter();this._device3DModel.THREEObject.applyMatrix((new THREE.Matrix4).makeTranslation(-t.x,-t.y,-t.z));var i=new THREE.Matrix4;i.makeRotationFromQuaternion(this._device3DModel.THREEObject.quaternion);var o=new THREE.Matrix4;if(o.getInverse(i),this._device3DModel.THREEObject.applyMatrix(o),this._device3DModel.THREEObject.applyMatrix((new THREE.Matrix4).makeTranslation(t.x,t.y,t.z)),ORG.deviceController){const t=ORGMessageBuilder.attitudeUpdate(e.quaternion);ORG.deviceController.sendMessage(t)}}}lookAtObject(e){new TWEEN.Tween(this._threeOrbitControls.target).to({x:e.position.x,y:e.position.y,z:e.position.z},kORGCameraTWEENDuration).easing(TWEEN.Easing.Quadratic.InOut).start()}lookFrontAtObject(e){new TWEEN.Tween(this._threeCamera.position).to({x:e.position.x,y:e.position.y,z:900},kORGCameraTWEENDuration).easing(TWEEN.Easing.Quadratic.InOut).start(),new TWEEN.Tween(this._threeOrbitControls.target).to({x:e.position.x,y:e.position.y,z:e.position.z},kORGCameraTWEENDuration).easing(TWEEN.Easing.Quadratic.InOut).start()}addDevice3DModel(e){this._device3DModel=e,this._device3DModel.addToScene(this._threeScene),this.devicePositionHasChanged()}showDevice3DModel(){this.hideDevice3DModel(),ORG3DDeviceModelLoader.loadDevice3DModel(ORG.device,this)}hideDevice3DModel(){this._device3DModel&&(this._device3DModel.destroy(),this._device3DModel=null),this.devicePositionHasChanged()}enableShowLocation(){if(this.flagShowLocation=!0,!this._locationMarker){const e=this._calculateFloorPosition();this._locationMarker=new ORG3DLocationMarker(e,this._lastLocationName,this._threeScene)}}disableShowLocation(){this.flagShowLocation=!1,this._locationMarker&&(this._locationMarker.destructor(),this._locationMarker=null)}setShowPrivate(e){this.flagShowPrivateClasses=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags;this._uiExpanded&&this._uiTreeModel&&this.collapseAndExpandAnimated()}setShowTextures(e){this.flagShowScreenshots=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags,this._uiTreeModel&&this._uiTreeModel.hideTextures(!e)}setShowInteractive(e){this.flagShowInteractiveViews=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags,this._uiExpanded&&this._uiTreeModel&&this.collapseAndExpandAnimated()}setShowNonInteractive(e){this.flagShowNonInteractiveViews=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags,this._uiExpanded&&this._uiTreeModel&&this.collapseAndExpandAnimated()}setShowHiddenViews(e){this.flagShowHiddenViews=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags,this._uiExpanded&&this._uiTreeModel&&this.collapseAndExpandAnimated()}setShowNormalWindow(e){}setShowKeyboardWindow(e){this.flagShowKeyboardWindow=e,this._uiTreeModel.visualizationFlags=this._treeVisualizationFlags,this._uiExpanded&&this._uiTreeModel&&this.collapseAndExpandAnimated()}setShowAlertWindow(e){}devicePositionHasChanged(){const e=this._deviceBoundingBox();this._adjustFloorPosition(e),this._adjustLocationMarkerPosition(e)}resize(e){this._threeRenderer.setSize(e.width,this._threeRenderer.getSize().height),this._threeCamera.aspect=e.width/this._threeRenderer.getSize().height,this._threeCamera.updateProjectionMatrix()}locationUpdate(e,t,i){if(this._lastLocationName=t||e.lat()+"  "+e.lng(),this.flagShowLocation)if(this._locationMarker)this._locationMarker.updateDescriptor(this._lastLocationName);else{const e=this._calculateFloorPosition();this._locationMarker=new ORG3DLocationMarker(e,this._lastLocationName,this._threeScene)}}_initialize(e,t){this._canvasDomElement=e;const i=this._canvasDomElement.clientWidth,o=this._canvasDomElement.clientHeight;this._threeScene=new THREE.Scene,this._threeCamera=new THREE.PerspectiveCamera(75,i/o,.1,1e4),this._threeRenderer=new THREE.WebGLRenderer({antialias:!0}),this._threeRenderer.domElement.style.position="absolute",this._threeRenderer.domElement.style.top=0,this._threeRenderer.setSize(i,o),this._canvasDomElement.appendChild(this._threeRenderer.domElement),this._threeRendererDOMElement=this._threeRenderer.domElement,this._threeOrbitControls=new THREE.OrbitControls(this._threeCamera,this._threeRenderer.domElement),this._keyboardState=new KeyboardState,t&&(this._sceneFloor=this._createFloor(this._threeScene)),this._createLights(),this._threeCamera.position.z=900,this._threeClock=new THREE.Clock,this._contextMenuManager=new ORGContextMenuManager(this),this._mouseListener=new ORGMouseListener(this._threeRendererDOMElement),this._mouseListener.addDelegate(this._contextMenuManager),this._mouseListener.enable(),this._render(),ORG.WindowResize(this._threeRenderer,this._threeCamera,this._canvasDomElement)}_calculateFloorPosition(){return this._sceneFloor?this._sceneFloor.position:new THREE.Vector3(0,kORGFloorPositionY,0)}_createFloor(e){return new ORG3DSceneFloor(4e3,50,!0,e,kORGFloorPositionY)}_removeFloor(){this._sceneFloor&&this._sceneFloor.remove(),this._sceneFloor=null}_createLights(){var e=new THREE.PointLight(11184810);e.position.set(500,-500,500),this._threeScene.add(e),(e=new THREE.PointLight(11184810)).position.set(500,500,500),this._threeScene.add(e),(e=new THREE.PointLight(11184810)).position.set(-500,-500,-500),this._threeScene.add(e),(e=new THREE.PointLight(11184810)).position.set(-500,500,-500),this._threeScene.add(e)}_updateScreenshot(){this._deviceScreen&&this._screenshotNeedsUpdate&&this._screenshotImage&&(this._screenshotNeedsUpdate=!1,this._deviceScreen.setScreenshot(this._screenshotImage))}_deviceBoundingBox(){let e=null;return this._sceneVisualFlags&ORGSceneVisualizationMask.ShowDevice&&this._device3DModel&&(e=this._device3DModel.getBoundingBox()),!e&&this._deviceScreen&&(e=this._deviceScreen.boundingBox),e}_adjustFloorPosition(e){e&&this._sceneFloor&&this._sceneFloor.setPosition(0,e.min.y-50,0)}_adjustLocationMarkerPosition(e){e&&this._locationMarker&&this._locationMarker.setPositionY(e.min.y-50)}_render(){const e=this;requestAnimationFrame(function(){e._threeRenderer.render(e._threeScene,e._threeCamera),e._threeOrbitControls.update(),e._updateScene(),TWEEN.update(),e._render()})}_updateScene(){this._updateScreenshot(),this._transformControl&&this._transformControl.update()}_transformControlChanged(){if(this._transformControl){const s=this._transformControl.object;if(s&&this._device3DModel){var e=(new THREE.Box3).setFromObject(this._device3DModel.THREEObject).getCenter();this._device3DModel.THREEObject.applyMatrix((new THREE.Matrix4).makeTranslation(-e.x,-e.y,-e.z));var t=new THREE.Matrix4;t.makeRotationFromQuaternion(this._device3DModel.THREEObject.quaternion);var i=new THREE.Matrix4;i.getInverse(t),this._device3DModel.THREEObject.applyMatrix(i);var o=new THREE.Matrix4;if(o.makeRotationFromQuaternion(s.quaternion),this._device3DModel.THREEObject.applyMatrix(o),this._device3DModel.THREEObject.applyMatrix((new THREE.Matrix4).makeTranslation(e.x,e.y,e.z)),ORG.deviceController){const e=ORGMessageBuilder.attitudeUpdate(s.quaternion);ORG.deviceController.sendMessage(e)}}}}}class ORGMessageBuilder{static deviceInfo(){var e={type:"request",data:{request:ORG.Request.DeviceInfo}};return JSON.stringify(e)}static appInfo(){var e={type:"request",data:{request:ORG.Request.AppInfo}};return JSON.stringify(e)}static takeScreenshot(){var e={type:"request",data:{request:ORG.Request.Screenshot}};return JSON.stringify(e)}static elementTree(e){var t={type:"request",data:{request:ORG.Request.ElementTree,parameters:e}};return JSON.stringify(t)}static gesture(e,t){var i={type:"request",data:{request:e,parameters:t}};return JSON.stringify(i)}static locationUpdate(e,t){var i={type:"update",data:{}};return e&&(i.data.location={lat:e.lat(),lng:e.lng()}),t&&(i.data.altimeter={altitude:t,pressure:1e3}),JSON.stringify(i)}static attitudeUpdate(e){var t={type:"update",data:{}};return e&&(t.data.deviceAttitude={qx:e.x,qy:e.z,qz:e.y,qw:e.w}),JSON.stringify(t)}}class ORGContextMenuManager{constructor(e){this._selectedThreeObject=null,this._intersectionPoint=null,this._scene=e;const t=this;$.contextMenu({selector:"#threejs-canvas",trigger:"none",build:function(e,i){return t._selectedThreeObject?{items:{tap:{name:"Tap"},"long-press":{name:"Long Press"},swipe:{name:"Swipe",items:{"swipe-left":{name:"Left"},"swipe-right":{name:"Right"},"swipe-up":{name:"Up"},"swipe-down":{name:"Down"}}},"-":{name:"-"},"look-at":{name:"Look at"},"look-front-at":{name:"Look Front at"}}}:{items:{"reset-camera-position":{name:"Reset Camera Position"},"reset-device-position":{name:"Reset Device Position"}}}},callback:function(e,i){t._processMenuSelection(e,t._selectedThreeObject,t._scene)}})}onContextMenu(e){$("#threejs-canvas").contextMenu({x:e.clientX,y:e.clientY})}mouseOverElement(e,t){this._selectedThreeObject=e,this._intersectionPoint=t}_processMenuSelection(e,t,i){if(!t)return void this._processMenuSelectionOnVoid(e,i);const o=i.deviceScreenBoundingBox,s={location:{x:this._intersectionPoint.x-o.min.x,y:o.max.y-this._intersectionPoint.y}};switch(e){case"tap":ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"long-press":s.duration=.5,ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"swipe-left":s.direction="left",ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"swipe-right":s.direction="right",ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"swipe-up":s.direction="up",ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"swipe-down":s.direction="down",ORG.deviceController.sendRequest(ORGMessageBuilder.gesture(e,s));break;case"look-at":i.lookAtObject(t);break;case"look-front-at":i.lookFrontAtObject(t)}}_processMenuSelectionOnVoid(e,t){switch(e){case"reset-camera-position":t.resetCameraPosition();break;case"reset-device-position":t.resetDevicePosition()}}}class ORGLocationProvider{constructor(){this._listeners=[]}addListener(e){this._listeners.push(e)}removeListeners(e){for(let t=0;t<this._listeners.length;t++)if(this._listeners[t]==e){this._listeners.splice(t,1);break}}removeListerners(){this._listeners=[]}_broadcastLocation(e,t,i){for(let o=0;o<this._listeners.length;o++)this._listeners[o].locationUpdate&&this._listeners[o].locationUpdate(e,t,i)}}class ORGMap extends ORGLocationProvider{constructor(){super(),this._map=this._createMap(document.getElementById("map"),!0),this._elevationService=new google.maps.ElevationService,this._geocoder=new google.maps.Geocoder,this._directionsService=new google.maps.DirectionsService,this._directionsDisplay=this._createDirectionsRenderer(this._map),this._directions=null,this._elevations=null,this._itineraryRunner=null,this._startLocationMarker=null,this._itineraryLocationMarker=null,this._startLocation=null,this._endLocation=null,this._initSearchBoxAutocomplete(),this._initAutocompleteStartLocation(),this._initAutocompleteEndLocation(),this._chart=new google.visualization.ColumnChart(document.getElementById("chart_div"))}get isCreated(){return!!this._map}get travelMode(){return ORG.UI.dropdownTravelMode.val()}run(){var e=new ORGItinerary(this._directions.routes[0],this._elevations,this._startLocation,this._endLocation);this._itineraryRunner=new ORGItineraryRunner(e),this._itineraryRunner.addListener(ORG.locationManager),this._itineraryRunner.start()}pause(){this._itineraryRunner&&this._itineraryRunner.pause()}resume(){this._itineraryRunner&&this._itineraryRunner.resume()}stop(){this._itineraryRunner&&this._itineraryRunner.stop()}updateItineraryLocation(e,t){if(this._itineraryLocationMarker||(this._itineraryLocationMarker=new google.maps.Marker({map:this._map,icon:"img/map_loc_20.png",anchorPoint:new google.maps.Point(10,10)})),e&&t){const i=new google.maps.LatLng(e,t);this._itineraryLocationMarker.setOptions({position:i,anchorPoint:new google.maps.Point(10,10)}),this._map.setCenter(i)}else this._itineraryLocationMarker.setMap(null),this._itineraryLocationMarker=null}resetItinerary(){this._startLocationMarker&&(this._startLocationMarker.setMap(null),this._startLocationMarker=null),this._directionsDisplay.setMap(null),this._directionsDisplay=null,this._directionsDisplay=this._createDirectionsRenderer(this._map),this._startLocation=null,this._endLocation=null;try{this._chart.clearChart()}catch(e){}ORG.dispatcher.dispatch({actionType:"reset-itinerary"})}sendStartLocationToDevice(){this._startLocation&&this._broadcastLocation(this._startLocation,null,null)}_createMap(e,t){var i=new google.maps.Map(e,{zoom:13,mapTypeId:"roadmap"});if(t){const e=this;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){const t={lat:e.coords.latitude,lng:e.coords.longitude};i.setCenter(t)},function(){_this_.handleLocationError(!0,i.getCenter())}):e._handleLocationError(!1,i.getCenter())}return i}_createDirectionsRenderer(e){const t=this;var i=new google.maps.DirectionsRenderer({map:e,preserveViewport:!0,draggable:!0});return google.maps.event.addListener(i,"directions_changed",function(){t._updateItineraryValues(i.getDirections()),t._elevationService.getElevationAlongPath({path:i.getDirections().routes[0].overview_path,samples:256},function(e){t._plotElevation(e)})}),i}_initSearchBoxAutocomplete(){const e=document.getElementById("pac-input"),t=new google.maps.places.SearchBox(e);this._map.controls[google.maps.ControlPosition.TOP_LEFT].push(e);const i=this;this._map.addListener("bounds_changed",function(){t.setBounds(i._map.getBounds())}),this._map.addListener("rightclick",function(e){i._onRightClick(e,i)}),this._map.addListener("click",function(e){i._onClick(e)}),t.addListener("places_changed",function(){const e=t.getPlaces();if(0==e.length)return;const o=new google.maps.LatLngBounds;e.forEach(function(e){e.geometry?e.geometry.viewport?o.union(e.geometry.viewport):o.extend(e.geometry.location):console.log("Returned place contains no geometry")}),i._map.fitBounds(o)})}_initAutocompleteStartLocation(){const e=this;var t=new google.maps.places.Autocomplete(document.getElementById("start-point"),null);google.maps.event.addListener(t,"place_changed",function(){e._autompleteSelectedStartPoint(t,e._map)})}_initAutocompleteEndLocation(){const e=this;var t=new google.maps.places.Autocomplete(document.getElementById("end-point"),null);google.maps.event.addListener(t,"place_changed",function(){e._autompleteSelectedEndPoint(t,e._map)})}_autompleteSelectedStartPoint(e,t){var i=e.getPlace();const o=i.geometry.location;t.panTo(o),this._setStartLocationWithAddress(o,i.formatted_address)}_autompleteSelectedEndPoint(e,t){var i=e.getPlace();const o=i.geometry.location;this._setEndLocationWithAddress(o,i.formatted_address)}_onClick(e){null==this._startLocation?this._setStartLocation(e.latLng):this._setEndLocation(e.latLng)}_onRightClick(e,t){}_setStartLocation(e){const t=this;this._getLocationAddress(e,function(i){t._setStartLocationWithAddress(e,i)})}_setStartLocationWithAddress(e,t){this._startLocation=e,this._startLocationMarker=this._createMarker(e,"A");const i=this;google.maps.event.addListener(this._startLocationMarker,"dragend",function(){i._startLocation=i._startLocationMarker.getPosition(),i._getLocationAddress(i._startLocation,function(e){i._broadcastLocation(i._startLocation,e,null),ORG.dispatcher.dispatch({actionType:"start-location-update",lat:i._startLocation.lat(),lng:i._startLocation.lng(),elevation:null,address:e})})}),this._getLocationInfoAndBroadcast(e),this._endLocation&&(this._removeMarker(),this._calcRoute()),ORG.dispatcher.dispatch({actionType:"start-location-update",lat:e.lat(),lng:e.lng(),elevation:null,address:t})}_setEndLocation(e){const t=this;this._getLocationAddress(e,function(i){t._setEndLocationWithAddress(e,i)})}_setEndLocationWithAddress(e,t){this._endLocation=e,this._startLocation&&(this._removeMarker(),this._calcRoute()),ORG.dispatcher.dispatch({actionType:"end-location-update",lat:e.lat(),lng:e.lng(),elevation:null,address:t})}_createMarker(e,t){return new google.maps.Marker({position:e,map:this._map,animation:google.maps.Animation.DROP,draggable:!0,label:t})}_removeMarker(){this._startLocationMarker&&(this._startLocationMarker.setMap(null),this._startLocationMarker=null)}_getLocationAddress(e,t){this._geocodePosition(e,function(e,i,o){t&&t(i)})}_getLocationInfoAndBroadcast(e){const t=this;this._geocodePosition(e,function(e,i,o){t._broadcastLocation(e,i,o)})}_geocodePosition(e,t){const i=this;this._geocoder.geocode({latLng:e},function(o){o&&o.length>0?i._elevationPosition(e,o[0].formatted_address,t):i._elevationPosition(e,null,t)})}_elevationPosition(e,t,i){this._elevationService.getElevationForLocations({locations:[e]},function(o,s){"OK"===s&&o[0]&&i&&i(e,t,o[0].elevation)})}_calcRoute(){const e={origin:this._startLocation,destination:this._endLocation,travelMode:this.travelMode};var t=this;this._directionsService.route(e,function(e,i){if(i==google.maps.DirectionsStatus.OK){t._directions=e,t._directionsDisplay.setDirections(e),t._elevationService.getElevationAlongPath({path:e.routes[0].overview_path,samples:256},function(e){t._elevations=e,t._plotElevation(e)})}})}_plotElevation(e){const t=e;var i=[];for(let o=0;o<e.length;o++)i.push(t[o].location);var o=new google.visualization.DataTable;o.addColumn("string","Sample"),o.addColumn("number","Elevation");for(let i=0;i<e.length;i++)o.addRow(["",t[i].elevation]);document.getElementById("chart_div").style.display="block",this._chart.draw(o,{height:160,legend:"none",titleY:"Elevation (m)",focusBorderColor:"#00ff00"})}_removeElevationChart(){document.getElementById("chart_div").style.display="none"}_handleLocationError(e,t){var i=new google.maps.InfoWindow;i.setPosition(t),i.setContent(e?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation."),i.open(map)}_calculateDistance(e){var t=0;const i=e.routes[0].legs.length;for(let o=0;o<i;o++)t+=e.routes[0].legs[o].distance.value;return t}_calculateDuration(e){var t=0;const i=e.routes[0].legs.length;for(let o=0;o<i;o++)t+=e.routes[0].legs[o].duration.value;return t}_updateItineraryValues(e){const t=e.routes[0].legs.length;this._startLocation=e.routes[0].legs[0].start_location,this._endLocation=e.routes[0].legs[t-1].end_location;const i=e.routes[0].legs[0].start_address,o=e.routes[0].legs[t-1].end_address,s=this._calculateDistance(e),n=this._calculateDuration(e);ORG.dispatcher.dispatch({actionType:"itinerary-changed",distance:s,duration:n,start_address:i,end_address:o,start_location:this._startLocation,end_location:this._endLocation})}}class ORGDevice{constructor(e){this.name=e.name,this.model=e.model,this.systemVersion=e.systemVersion,this.productName=e.productName}}ORG.testApp=null;class ORGDeviceBaseController{constructor(e,t){this._ip=e,this._port=t}get type(){_throwError()}get isConnected(){_throwError()}get RESTPrefix(){return"http://"+this.IPandPort}get IPandPort(){return this._ip+":"+this._port}openSession(){_throwError()}closeSession(){_throwError()}screenshot(){_throwError()}elementTree(){_throwError()}_throwError(){throw new Error("Executing base class method. Subclass must implement this method.")}}class ORGDeviceController extends ORGDeviceBaseController{constructor(e,t){super(e,t),this.session=null,this.webSocket=new ORGWebSocket,this.webSocketDelegate=new ORGOrganismoWSDelegate}get type(){return"ORG"}get isConnected(){return this.webSocket.isConnected()}openSession(){this.webSocket.open(this.IPandPort,this.webSocketDelegate)}closeSession(){this.webSocket.close()}requestDeviceInfo(){this.webSocket.send(ORGMessageBuilder.deviceInfo())}requestAppInfo(){this.webSocket.send(ORGMessageBuilder.appInfo())}requestScreenshot(){this.webSocket.send(ORGMessageBuilder.takeScreenshot())}requestElementTree(e){this.webSocket.send(ORGMessageBuilder.elementTree(e))}sendRequest(e){this.webSocket.send(e)}sendMessage(e){this.webSocket.send(e)}}class ORGDeviceWDAController extends ORGDeviceBaseController{constructor(e,t){super(e,t),this.xhr=new XMLHttpRequest,this.session=null}get type(){return"WDA"}get isConnected(){return null!=this.session}openSession(){var e=this.RESTPrefix+"/session";this.xhr.open("POST",e,!0),this.xhr.onreadystatechange=function(){if(4==this.readyState&&200==this.status)JSON.parse(this.responseText)},this.xhr.send()}closeSession(){var e=this.RESTPrefix+"/";xhr.open("POST",e,!0),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status)JSON.parse(xhr.responseText)},xhr.send()}screenshot(){}elementTree(){}}class ORGWebSocketDeviceController extends ORGDeviceBaseController{constructor(e,t){super(e,t),this.session=null,this.webSocket=new ORGWebSocket,this.webSocketDelegate=new ORGiControlProxyWSDelegate}get isConnected(){return this.webSocket.isConnected()}openSession(){this.webSocket.open(this.IPandPort,this.webSocketDelegate)}closeSession(){this.webSocket.close()}sendRequest(e){this.webSocket.send(e)}sendMessage(e){this.webSocket.send(e)}}class ORGiMobileDeviceController extends ORGWebSocketDeviceController{get type(){return"iDeviceControlProxy"}requestDeviceInfo(){this.webSocket.send('{ "cmd" : "ideviceinfo" }')}requestAppInfo(){}requestScreenshot(){this.webSocket.send('{ "cmd" : "idevicescreenshot" }')}requestElementTree(e){}sendLocationUpdate(e,t){this.webSocket.send('{ "cmd" : "idevicelocation" , "args" : "-- '+e+" "+t+'"}')}}class ORG3DSceneFloor{constructor(e,t,i,o,s){this._threeScene=o,this._yPos=s,i&&(this._threeAxis=new THREE.AxisHelper(650),this._threeAxis.position.set(-e/2,this._yPos,-e/2),this._threeScene.add(this._threeAxis)),this._threeFloor=new THREE.GridHelper(e,t,new THREE.Color(6710886),new THREE.Color(6710886)),this._threeFloor.position.set(0,this._yPos,0),this._threeScene.add(this._threeFloor)}get position(){return this._threeFloor.position}remove(){this._threeFloor&&(this._threeScene.remove(this._threeFloor),this._threeFloor=null),this._threeAxis&&(this._threeScene.remove(this._threeAxis),this._threeAxis=null)}setPosition(e,t,i){this._threeFloor&&this._threeFloor.position.setY(t),this._threeAxis&&this._threeAxis.position.setY(t)}}class ORG3DDeviceModelLoader{static loadDevice3DModel(e,t){e.productName.startsWith("iPhone 5")?this._load_iPhone_5(t):e.productName.startsWith("iPhone 6")&&this._load_iPhone_6(t)}static _load_iPhone_6(e){(new THREE.OBJLoader).load("3DModels/iPhone/iPhone_6.obj",function(t){t.position.set(0,-480,-24),t.scale.set(124,124,124),e.addDevice3DModel(new ORG3DDeviceModel(t))})}static _load_iPhone_5(e){(new THREE.OBJLoader).load("3DModels/iPhone_5/iPhone5.obj",function(t){t.scale.set(.8,.8,.8),t.position.set(0,0,-28),e.addDevice3DModel(new ORG3DDeviceModel(t))})}}class ORG3DDeviceModel{constructor(e){this.threeObj=e,this.threeScene=null}get THREEObject(){return this.threeObj}addToScene(e){this.threeScene=e,this.threeObj&&this.threeScene.add(this.threeObj)}removeFromScene(){this.threeScene&&this.threeObj&&this.threeScene.remove(this.threeObj)}destroy(){this.removeFromScene(),this.threeObj=null}setOrientation(e){if(this.threeObj)switch(e){case"portrait":var t=this.threeObj.rotation,i=(o=(new THREE.Box3).setFromObject(this.threeObj)).getCenter();this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(-i.x,-i.y,-i.z)),this.threeObj.applyMatrix((new THREE.Matrix4).makeRotationZ(-t.z)),this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,i.y,i.z));break;case"landscapeLeft":i=(o=(new THREE.Box3).setFromObject(this.threeObj)).getCenter();this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(-i.x,-i.y,-i.z)),this.threeObj.applyMatrix((new THREE.Matrix4).makeRotationZ(THREE.Math.degToRad(-90))),this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,i.y,i.z));break;case"landscapeRight":var o=(new THREE.Box3).setFromObject(this.threeObj),i=o.getCenter();this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(-i.x,-i.y,-i.z)),this.threeObj.applyMatrix((new THREE.Matrix4).makeRotationZ(THREE.Math.degToRad(90))),this.threeObj.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,i.y,i.z))}}getBoundingBox(){return(new THREE.Box3).setFromObject(this.threeObj)}}class ORG3DDeviceScreen{constructor(e,t,i,o){var s,n;this._deviceScreenSize={width:e,height:t},this._threeScene=o,(s=new THREE.PlaneBufferGeometry(e,t,1,1)).dynamic=!0,n=new THREE.MeshBasicMaterial({map:null,color:16777215,side:THREE.DoubleSide}),this._threeScreenPlane=new THREE.Mesh(s,n),this._threeScreenPlane.position.set(0,0,i),this._threeScreenPlane.name="screen",o.add(this._threeScreenPlane),this._threeScreenPlane.geometry.computeBoundingBox()}destroy(){this._threeScene&&this._threeScreenPlane&&(this._threeScene.remove(this._threeScreenPlane),this._threeScreenPlane=null)}get screenPlane(){return this._threeScreenPlane}get boundingBox(){return this._threeScreenPlane.geometry.boundingBox}get screenSize(){return this._deviceScreenSize}hide(){this._threeScreenPlane&&(this._threeScreenPlane.visible=!1)}show(){this._threeScreenPlane&&(this._threeScreenPlane.visible=!0)}setScreenshot(e){var t=new THREE.Texture(e);t.minFilter=THREE.NearestFilter;var i=this;e.onload=function(){t.needsUpdate=!0,i._threeScreenPlane.material.map=t,i._threeScreenPlane.material.needsUpdate=!0,i._threeScreenPlane.needsUpdate=!0}}}class ORGWebSocketDelegate{constructor(){this.connected=!1}onOpen(e){console.log("Delegate onOpen"),this.connected=!0,ORG.dispatcher.dispatch({actionType:"websocket-open"})}onClose(e,t){console.log("Delegate onClose."),ORG.scene.handleDeviceDisconnection(),ORG.dispatcher.dispatch({actionType:"websocket-closed",code:e.code,reason:e.reason,deviceController:ORG.deviceController.constructor.name})}onMessage(e,t){var i=JSON.parse(e.data);if(i){if(i)if("response"==i.type)this._processResponse(i);else if("notification"==i.type)this._processNotification(i.body);else if("CoreMotionFeed"==i.command){var o=i.content;this._processMotionFeedMessage(o)}}else console.log("onMessage. parse NOT OK")}onError(e,t){console.log("WS Error: "+e.data)}_processResponse(e){e.request==ORG.Request.DeviceInfo?this._processResponseDeviceInfo(e.data):e.request==ORG.Request.AppInfo?this._processResponseAppInfo(e):e.request==ORG.Request.Screenshot?this._processReportScreenshot(e):e.request==ORG.Request.ElementTree&&this._processReportElementTree(e)}_processNotification(e){"orientation-change"==e.notification&&this._processNotificationOrientationChanged(e.parameters)}_processNotificationOrientationChanged(e){if(e){var t=e.screenSize,i=e.orientation;t&&i&&ORG.scene.setDeviceOrientation(i,t.width,t.height)}}_processResponseDeviceInfo(e){ORG.device=new ORGDevice(e),ORG.scene.createDeviceScreen(e.screenSize.width,e.screenSize.height,0),ORG.scene.createRaycasterForDeviceScreen(),ORG.scene.flagShowDevice3DModel&&ORG.scene.showDevice3DModel(),ORG.scene.devicePositionHasChanged(),ORG.deviceController.requestScreenshot(),ORG.UI.deviceNameLabel.text(ORG.device.name),ORG.UI.deviceSystemVersionLabel.text(ORG.device.systemVersion),ORG.UI.deviceModelLabel.text(ORG.device.productName)}_processResponseAppInfo(e){ORG.testApp=new ORGTestApp(e.data),ORG.UI.testAppNameLabel.text(ORG.testApp.name),ORG.UI.testAppVersionLabel.text(ORG.testApp.version),ORG.UI.testAppBundleIdLabel.text(ORG.testApp.bundleIdentifier)}_processReportScreenshot(e){var t=e.data.screenshot;if(t){var i=new Image;i.src="data:image/jpg;base64,"+t,ORG.scene.setScreenshotImage(i),ORG.scene.flagContinuousScreenshot&&!ORG.scene.isExpanded&&ORG.deviceController.isConnected&&ORG.deviceController.requestScreenshot()}}_processReportElementTree(e){var t=e.data;t&&(ORG.treeEditor.set(t),ORG.scene.updateUITreeModel(t))}}class ORGiControlProxyWSDelegate extends ORGWebSocketDelegate{constructor(){super()}onOpen(e){super.onOpen(e),ORG.deviceController.requestDeviceInfo()}onMessage(e,t){var i=e.data.replace(/\n/g,"\\r"),o=JSON.parse(i);o?"success"==o.status?this._processResponse(o):console.log("onMessage. cmd response failure. cmd:"+o.cmd):console.log("onMessage. parse NOT OK")}_processResponse(e){switch(e.cmd){case"ideviceinfo":{const t=this._deviceInfoFromResponse(e.response);this._processResponseDeviceInfo(t)}break;case"idevicescreenshot":this._processReportScreenshot({data:{screenshot:e.response}})}}_deviceInfoFromResponse(e){var t,i,o=/DeviceName: (.*)(\r)(.*)/.exec(e);return o&&o.length>=2&&(t=o[1]),(o=/ProductVersion: (.*)(\r)(.*)/.exec(e))&&o.length>=2&&(i=o[1]),{name:t,model:"model",systemVersion:i,productName:"iPhone 5",screenSize:{height:568,width:320}}}}class ORGOrganismoWSDelegate extends ORGWebSocketDelegate{constructor(){super()}onOpen(e){super.onOpen(e),ORG.deviceController.requestDeviceInfo(),ORG.deviceController.requestAppInfo()}}class ORG3DRaycaster{constructor(e,t,i){this._raycaster=new THREE.Raycaster,this._rcmouse=new THREE.Vector2,this._hilitedObj=null,this._myMouseDown=!1,this._threeTargetObject=i,this._rendererDomElement=e,this._threeCamera=t,this._listeners=[],this._enabled=!0}addDelegate(e){this._listeners.push(e)}removeDelegate(e){for(var t=0;t<this._listeners.length;t++)if(this._listeners[t]==e){this._listeners.splice(t,1);break}}onMouseDown(e){if(this._myMouseDown=!0,this._hilitedObj){var t=this._hilitedObj.object.parent.userData,i={};for(var o in t)"threeObj"!=o&&"children"!=o&&(i[o]=t[o])}}onMouseUp(e){this._myMouseDown=!1}onMouseMove(e){if(!this._myMouseDown&&this._threeTargetObject){var t=$(this._rendererDomElement).width(),i=$(this._rendererDomElement).height(),o=$(this._rendererDomElement).offset();this._rcmouse.x=(e.clientX-o.left)/t*2-1,this._rcmouse.y=-(e.clientY-o.top)/i*2+1,this._raycaster.setFromCamera(this._rcmouse,this._threeCamera);var s=this._raycaster.intersectObject(this._threeTargetObject,!0),n=null,r=null;if(s&&s.length&&(n=s[0].object,r=s[0].point,n instanceof THREE.BoxHelper)){var a=n.parent;if(n=null,a)for(var l in a.children)if(a.children[l]instanceof THREE.BoxHelper==0){n=a.children[l];break}}for(l=0;l<this._listeners.length;l++)this._listeners[l].mouseOverElement&&this._listeners[l].mouseOverElement(n,r)}}}class ORGLocationManager extends ORGLocationProvider{constructor(){super(),this._location=null,this._address=null,this._elevation=null}get location(){return this._location}get address(){return this._address}get elevation(){return this._elevation}locationUpdate(e,t,i){this._location=e,this._address=t,this._elevation=i,ORG.deviceController&&ORG.deviceController.sendLocationUpdate(e.lat(),e.lng()),this._broadcastLocation(e,t,i)}}class ORGFluxStore extends FluxUtils.Store{__onDispatch(e){switch(e.actionType){case"device-disconnect":ORG.UI.connectButton.text("Connect"),ORG.UI.buttonExpand.text("Expand"),ORG.UI.deviceNameLabel.text(""),ORG.UI.deviceSystemVersionLabel.text(""),ORG.UI.deviceModelLabel.text(""),ORG.UI.testAppBundleIdLabel.text(""),ORG.UI.testAppNameLabel.text(""),ORG.UI.testAppVersionLabel.text("");break;case"itinerary-location-update":ORG.map.updateItineraryLocation(e.lat,e.lng);break;case"start-location-update":$("#label-lat").text(e.lat),$("#label-lng").text(e.lng),e.elevation&&$("#label-altitude").text(e.elevation+"m"),e.address&&ORG.UI.startPoint.val(e.address);break;case"end-location-update":$("#label-lat-end").text(e.lat),$("#label-lng-end").text(e.lng),e.elevation&&$("#label-altitude-end").text(e.elevation+"m"),ORG.UI.endPoint.val(e.address);break;case"reset-itinerary":$("#label-lat").text(""),$("#label-lng").text(""),$("#label-lat-end").text(""),$("#label-lng-end").text(""),$("#label-altitude").text(""),$("#label-distance").text(""),$("#label-duration").text(""),ORG.UI.startPoint.val(""),ORG.UI.endPoint.val("");break;case"itinerary-changed":$("#label-distance").text(e.distance+"m"),$("#label-duration").text(e.duration+"s"),ORG.UI.startPoint.val(e.start_address),ORG.UI.endPoint.val(e.end_address),$("#label-lat").text(e.start_location.lat()),$("#label-lng").text(e.start_location.lng()),$("#label-lat-end").text(e.end_location.lat()),$("#label-lng-end").text(e.end_location.lng());break;case"websocket-open":ORG.UI.connectButton.text("Disconnect");break;case"websocket-closed":ORG.UI.connectButton.text("Connect"),ORG.UI.buttonExpand.text("Expand"),ORG.UI.deviceNameLabel.text(""),ORG.UI.deviceSystemVersionLabel.text(""),1006==e.code&&("ORGDeviceController"==e.deviceController?alert("Error connecting to device.\nMake sure the device is connected and the application is open."):alert("Error connecting to idevicecontrolproxy.\nMake sure the proxy is running.\nRead about it @ https://github.com/JonGabilondoAngulo/idevicecontrolproxy"))}}}ORG.SplitterResize=function(e,t,i,o){$(t).resizable({handles:"e,w",minWidth:500,resize:function(s,n){const r=e.offsetWidth-n.size.width,a=n.size.width;t.style.width=a+"px",ORG.canvasDomElem.style.width=a+"px",o.resize(n.size),i.style.width=r+"px"}})},ORG.WindowResize=function(e,t,i){var o=function(){var o=window.innerHeight-66;e.setSize(i.offsetWidth,o),t.aspect=i.offsetWidth/o,t.updateProjectionMatrix(),i.style.height=o+"px"};return o(),window.addEventListener("resize",o,!1),{stop:function(){window.removeEventListener("resize",o)}}},ORG.contentWrapper=document.getElementById("content-wrapper"),ORG.leftSection=document.getElementById("3d-canvas-col"),ORG.canvasDomElem=document.getElementById("threejs-canvas"),ORG.rightSection=document.getElementById("right-tabs"),ORG.scene=new ORG3DScene(ORG.canvasDomElem,{width:320,height:568}),ORG.locationManager=new ORGLocationManager,ORG.locationManager.addListener(ORG.scene),ORG.deviceController=null,ORG.device=null,ORG.map=null,ORG.fontLoader=new THREE.FontLoader,ORG.fontLoader.load("three.js/examples/fonts/helvetiker_regular.typeface.json",function(e){ORG.font_helvetiker_regular=e}),ORG.Request={AppInfo:"app-info",DeviceInfo:"device-info",Screenshot:"screenshot",ElementTree:"element-tree"},ORG.dispatcher=new Flux.Dispatcher,ORG.fluxStore=new ORGFluxStore(ORG.dispatcher),ORG.SplitterResize(ORG.contentWrapper,ORG.leftSection,ORG.rightSection,ORG.scene),google.charts.load("current",{packages:["columnchart"]}),ORG.UI.connectButton=$("#connect-button"),ORG.UI.deviceNameLabel=$("#device-name-label"),ORG.UI.deviceSystemVersionLabel=$("#device-system-version-label"),ORG.UI.deviceModelLabel=$("#device-model-label"),ORG.UI.testAppNameLabel=$("#testapp-name-label"),ORG.UI.testAppVersionLabel=$("#testapp-version-label"),ORG.UI.testAppBundleIdLabel=$("#testapp-bundleid-label"),ORG.UI.dropdownDriver=$("#selected"),$(".dropdown-menu a").click(function(){$(this).parents(".btn-group").children(":first").text($(this).text()),$(this).parents(".btn-group").children(":first").val($(this).data("value"))}),ORG.UI.connectButton.click(function(e){var t=$("#device-url").val();if(""==t&&(t="localhost"),null==ORG.deviceController){var i=ORG.UI.dropdownDriver.text();"Organismo"==i?ORG.deviceController=new ORGDeviceController(t,5567):"iDeviceControlProxy"==i&&(ORG.deviceController=new ORGiMobileDeviceController(t,8e3))}ORG.deviceController.isConnected?(ORG.deviceController.closeSession(),ORG.scene.handleDeviceDisconnection(),ORG.dispatcher.dispatch({actionType:"device-disconnect"}),ORG.deviceController=null):ORG.deviceController.openSession()});var jse_container=document.getElementById("json-editor"),jse_options={mode:"view",sortObjectKeys:!0,search:!1,expandCollapse:!1,fieldsSorter:sortTreeNodes,nodeFormatter:formatNode},jse_json={screenshot:"1234567890",other:"hello",class:"UIWindow",subviews:[{screenshot:"1234567890",other:"hello2",class:"UIView"},{screenshot:"1234567890",other:"hello3",class:"UIButton"}]};ORG.treeEditor=new JSONEditor(jse_container,jse_options,jse_json),ORG.UI.checkButtonShowFloor=$("#show-floor"),ORG.UI.checkButtonShowDevice=$("#show-device"),ORG.UI.checkButtonShowLocation=$("#show-location"),ORG.UI.checkButtonShowTextures=$("#show-textures"),ORG.UI.checkButtonShowInteractive=$("#show-interactive"),ORG.UI.checkButtonShowNonInteractive=$("#show-non-interactive"),ORG.UI.checkButtonShowPrivate=$("#show-private"),ORG.UI.checkButtonShowTooltips=$("#show-tooltips"),ORG.UI.checkButtonLiveScreen=$("#live-screen"),ORG.UI.checkButtonShowHiddenViews=$("#show-hidden-views"),ORG.UI.checkButtonShowNormalWindow=$("#show-normal-window"),ORG.UI.checkButtonShowKeyboardWindow=$("#show-keyboard-window"),ORG.UI.checkButtonShowAlertWindow=$("#show-alert-window"),ORG.UI.buttonExpand=$("#expand-button"),ORG.UI.buttonResetCamera=$("#reset-camera-button"),ORG.UI.buttonRotateDevice=$("#rotate-device-button"),ORG.UI.buttonItineraryStart=$("#itinerary-run"),ORG.UI.buttonItineraryStop=$("#itinerary-stop"),ORG.UI.buttonItineraryPause=$("#itinerary-pause"),ORG.UI.buttonItineraryResume=$("#itinerary-resume"),ORG.UI.buttonSendLocation=$("#button-send-location"),ORG.UI.startPoint=$("#start-point"),ORG.UI.endPoint=$("#end-point"),ORG.UI.dropdownTravelMode=$("#travel-mode-dropdown"),ORG.UI.buttonResetItinerary=$("#reset-itinerary"),ORG.UI.checkButtonShowDevice.change(function(e){1==$(this).is(":checked")?ORG.scene.showDevice3DModel():ORG.scene.hideDevice3DModel()}),ORG.UI.checkButtonShowFloor.change(function(e){1==$(this).is(":checked")?ORG.scene.createFloor():ORG.scene.removeFloor()}),ORG.UI.checkButtonShowLocation.change(function(e){1==$(this).is(":checked")?ORG.scene.enableShowLocation():ORG.scene.disableShowLocation()}),ORG.UI.checkButtonShowTextures.change(function(e){ORG.scene.setShowTextures($(this).is(":checked"))}),ORG.UI.checkButtonShowInteractive.change(function(e){ORG.scene.setShowInteractive($(this).is(":checked"))}),ORG.UI.checkButtonShowNonInteractive.change(function(e){ORG.scene.setShowNonInteractive($(this).is(":checked"))}),ORG.UI.checkButtonShowPrivate.change(function(e){ORG.scene.setShowPrivate($(this).is(":checked"))}),ORG.UI.checkButtonShowTooltips.change(function(e){ORG.scene.showTooltips($(this).is(":checked"))}),ORG.UI.checkButtonShowHiddenViews.change(function(e){ORG.scene.setShowHiddenViews($(this).is(":checked"))}),ORG.UI.checkButtonLiveScreen.change(function(e){ORG.scene.setLiveScreen($(this).is(":checked"))}),ORG.UI.checkButtonShowNormalWindow.change(function(e){ORG.scene.setShowNormalWindow($(this).is(":checked"))}),ORG.UI.checkButtonShowKeyboardWindow.change(function(e){ORG.scene.setShowKeyboardWindow($(this).is(":checked"))}),ORG.UI.checkButtonShowAlertWindow.change(function(e){ORG.scene.setShowAlertWindow($(this).is(":checked"))}),ORG.UI.buttonResetCamera.click(function(e){ORG.scene.resetCameraPosition()}),ORG.UI.buttonRotateDevice.click(function(e){ORG.scene.rotateDevice()}),ORG.UI.buttonExpand.click(function(e){ORG.deviceController.isConnected&&(ORG.scene.isExpanded?(ORG.UI.buttonExpand.text("Expand"),ORG.scene.collapse()):(ORG.UI.buttonExpand.text("Collapse"),ORG.scene.expand()))}),ORG.UI.buttonResetItinerary.click(function(e){ORG.map.resetItinerary()}),ORG.UI.buttonItineraryStart.click(function(e){ORG.map.run()}),ORG.UI.buttonItineraryStop.click(function(e){ORG.map.stop()}),ORG.UI.buttonItineraryPause.click(function(e){ORG.map.pause()}),ORG.UI.buttonItineraryResume.click(function(e){ORG.map.resume()}),ORG.UI.buttonSendLocation.click(function(e){ORG.map.sendStartLocationToDevice()});class ORG3DLocationMarker{constructor(e,t,i){this._descriptor=null,this._marker=null,this._anchorPoint=e,this._threeScene=i,this._marker=this._createMarker(this._anchorPoint),this._threeScene.add(this._marker),this.updateDescriptor(t)}destructor(){this._removeMarker(),this._removeDescriptor()}updateDescriptor(e){this._threeScene&&(this._removeDescriptor(),this._descriptor=this._createDescriptor(e),this._threeScene.add(this._descriptor))}setPositionY(e){this._marker&&this._marker.position.setY(e),this._placeDescriptor(this._descriptor)}_createMarker(e){const t=new THREE.CylinderGeometry(30,30,10,30,8,!1);var i=new THREE.MeshPhongMaterial({color:238});i.side=THREE.DoubleSide;var o=THREE.SceneUtils.createMultiMaterialObject(t,[i]);return o.position.setY(e.y),o}_createDescriptor(e){const t=new THREE.TextGeometry(e,{font:ORG.font_helvetiker_regular,size:40,height:5,curveSegments:12,bevelEnabled:!1,bevelThickness:10,bevelSize:8,bevelSegments:5}),i=new THREE.MeshPhongMaterial({color:15658734}),o=new THREE.Mesh(t,i);return this._placeDescriptor(o),o}_removeMarker(){this._threeScene&&this._marker&&(this._threeScene.remove(this._marker),this._marker=null)}_removeDescriptor(){this._threeScene&&this._descriptor&&(this._threeScene.remove(this._descriptor),this._descriptor=null)}_placeDescriptor(e){if(this._marker&&e){e.position.set(0,0,0),e.rotation.set(THREE.Math.degToRad(-90),0,0),e.updateMatrix(),e.geometry.computeBoundingBox();const t=e.geometry.boundingBox.getCenter();e.position.set(-t.x,this._marker.position.y,100)}}}google.maps.LatLng.prototype.distanceFrom=function(e){var t=this.lat(),i=this.lng(),o=e.lat(),s=e.lng(),n=(o-t)*Math.PI/180,r=(s-i)*Math.PI/180,a=Math.sin(n/2)*Math.sin(n/2)+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 6378137*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))},google.maps.LatLng.prototype.latRadians=function(){return this.lat()*Math.PI/180},google.maps.LatLng.prototype.lngRadians=function(){return this.lng()*Math.PI/180},google.maps.Polygon.prototype.Contains=function(e){for(var t=0,i=!1,o=e.lng(),s=e.lat(),n=0;n<this.getPath().getLength();n++)++t==this.getPath().getLength()&&(t=0),(this.getPath().getAt(n).lat()<s&&this.getPath().getAt(t).lat()>=s||this.getPath().getAt(t).lat()<s&&this.getPath().getAt(n).lat()>=s)&&this.getPath().getAt(n).lng()+(s-this.getPath().getAt(n).lat())/(this.getPath().getAt(t).lat()-this.getPath().getAt(n).lat())*(this.getPath().getAt(t).lng()-this.getPath().getAt(n).lng())<o&&(i=!i);return i},google.maps.Polygon.prototype.Area=function(){for(var e=0,t=0,i=this.Bounds(),o=i.getSouthWest().lng(),s=i.getSouthWest().lat(),n=0;n<this.getPath().getLength();n++){++t==this.getPath().getLength()&&(t=0);var r=this.getPath().getAt(n).distanceFrom(new google.maps.LatLng(this.getPath().getAt(n).lat(),o)),a=this.getPath().getAt(t).distanceFrom(new google.maps.LatLng(this.getPath().getAt(t).lat(),o)),l=this.getPath().getAt(n).distanceFrom(new google.maps.LatLng(s,this.getPath().getAt(n).lng()));e+=r*this.getPath().getAt(t).distanceFrom(new google.maps.LatLng(s,this.getPath().getAt(t).lng()))-a*l}return Math.abs(.5*e)},google.maps.Polygon.prototype.Distance=function(){for(var e=0,t=1;t<this.getPath().getLength();t++)e+=this.getPath().getAt(t).distanceFrom(this.getPath().getAt(t-1));return e},google.maps.Polygon.prototype.Bounds=function(){for(var e=new google.maps.LatLngBounds,t=0;t<this.getPath().getLength();t++)e.extend(this.getPath().getAt(t));return e},google.maps.Polygon.prototype.GetPointAtDistance=function(e){if(0==e)return this.getPath().getAt(0);if(e<0)return null;if(this.getPath().getLength()<2)return null;for(var t=0,i=0,o=1;o<this.getPath().getLength()&&t<e;o++)i=t,t+=this.getPath().getAt(o).distanceFrom(this.getPath().getAt(o-1));if(t<e)return null;var s=this.getPath().getAt(o-2),n=this.getPath().getAt(o-1),r=(e-i)/(t-i);return new google.maps.LatLng(s.lat()+(n.lat()-s.lat())*r,s.lng()+(n.lng()-s.lng())*r)},google.maps.Polygon.prototype.GetPointsAtDistance=function(e){var t=e,i=[];if(e<=0)return i;for(var o=0,s=0,n=1;n<this.getPath().getLength();n++)for(s=o,o+=this.getPath().getAt(n).distanceFrom(this.getPath().getAt(n-1));o>t;){var r=this.getPath().getAt(n-1),a=this.getPath().getAt(n),l=(t-s)/(o-s);i.push(new google.maps.LatLng(r.lat()+(a.lat()-r.lat())*l,r.lng()+(a.lng()-r.lng())*l)),t+=e}return i},google.maps.Polygon.prototype.GetIndexAtDistance=function(e){if(0==e)return this.getPath().getAt(0);if(e<0)return null;for(var t=0,i=1;i<this.getPath().getLength()&&t<e;i++)t,t+=this.getPath().getAt(i).distanceFrom(this.getPath().getAt(i-1));return t<e?null:i},google.maps.Polygon.prototype.Bearing=function(e,t){if(null==e?(e=0,t=this.getPath().getLength()-1):null==t&&(t=e+1),!(e<0||e>=this.getPath().getLength()||t<0||t>=this.getPath().getLength())){var i=this.getPath().getAt(e),o=this.getPath().getAt(t);if(i.equals(o))return 0;var s=i.latRadians(),n=i.lngRadians(),r=o.latRadians(),a=o.lngRadians(),l=-Math.atan2(Math.sin(n-a)*Math.cos(r),Math.cos(s)*Math.sin(r)-Math.sin(s)*Math.cos(r)*Math.cos(n-a));return l<0&&(l+=2*Math.PI),l=180*l/Math.PI,parseFloat(l.toFixed(1))}},google.maps.Polyline.prototype.Contains=google.maps.Polygon.prototype.Contains,google.maps.Polyline.prototype.Area=google.maps.Polygon.prototype.Area,google.maps.Polyline.prototype.Distance=google.maps.Polygon.prototype.Distance,google.maps.Polyline.prototype.Bounds=google.maps.Polygon.prototype.Bounds,google.maps.Polyline.prototype.GetPointAtDistance=google.maps.Polygon.prototype.GetPointAtDistance,google.maps.Polyline.prototype.GetPointsAtDistance=google.maps.Polygon.prototype.GetPointsAtDistance,google.maps.Polyline.prototype.GetIndexAtDistance=google.maps.Polygon.prototype.GetIndexAtDistance,google.maps.Polyline.prototype.Bearing=google.maps.Polygon.prototype.Bearing;class ORGItinerary{constructor(e,t,i,o){this._startLocation=i,this._endLocation=o,this._duration=0,this._polyline=this._calculateRoutePolyline(e),this._length=google.maps.geometry.spherical.computeLength(this._polyline.getPath().getArray()),this._elevations=t,this._startDate=null,this._mode=null}get startlocation(){return this._startLocation}get endLocation(){return this._endLocation}get duration(){return this._duration}get length(){return this._length}get polyline(){return this._polyline}get elevations(){return this._elevations}_calculateRoutePolyline(e){const t=e.legs;var i=new google.maps.Polyline({path:[],strokeColor:"#FF0000",strokeWeight:3});for(let e=0;e<t.length;++e){t[e].distance.value,t[e].duration.value;const o=t[e].steps;for(let e=0;e<o.length;e++){let t=o[e].path;for(let e=0;e<t.length;e++)i.getPath().push(t[e])}}return i}}class ORGItineraryLocation{constructor(e,t,i){this._routePolyline=e,this._elevations=t,this._routeTotalDistance=i,this._lastLocation=null,this._lastLocationTime=0,this._currentLocation=null,this._distance=0,this._speed=0}set distance(e){const t=(new Date).getTime()/1e3;if(this._lastLocationTime>0){const i=t-this._lastLocationTime,o=e-this._distance;this._speed=o/i}this._distance=e,this._lastLocation=this._currentLocation,this._currentLocation=this._routePolyline.GetPointAtDistance(this._distance),this._lastLocationTime=t}get distance(){return this._distance}get location(){return this._currentLocation}get course(){return this._bearing(this._lastLocation,this._currentLocation)}get speed(){return this._speed}get elevation(){var e=0;if(this._elevations){var t=this._routeTotalDistance/this._elevations.length;const i=Math.floor(this._distance/t),o=Math.ceil(this._distance/t);if(o>=this._elevations.length)e=this._elevations[i].elevation;else{const s=this._elevations[i].elevation,n=this._elevations[o].elevation,r=this._elevations[i].location;e=(t=this._elevations[i].location.distanceFrom(r))>0?s+this._currentLocation.distanceFrom(r)/t*(n-s):s}}return e}_bearing(e,t){if(null==from||null==t)return 0;const i=from.lat()*Math.PI/180,o=from.lng()*Math.PI/180,s=t.lat()*Math.PI/180,n=t.lng()*Math.PI/180;let r=-Math.atan2(Math.sin(o-n)*Math.cos(s),Math.cos(i)*Math.sin(s)-Math.sin(i)*Math.cos(s)*Math.cos(o-n));return r<0&&(r+=2*Math.PI),r*(180/Math.PI)}}ORG.RunnerState={IDLE:"idle",RUNNING:"running",PAUSED:"paused"};class ORGItineraryRunner extends ORGLocationProvider{constructor(e){super(),this._itinerary=e,this._state=ORG.RunnerState.IDLE,this._stepDelta=5,this._nextStepDistance=0,this._itineraryLocation=new ORGItineraryLocation(this._itinerary.polyline,this._itinerary.elevations,this._itinerary._length)}start(){this._nextStepDistance=0,this._state=ORG.RunnerState.RUNNING,this._executeRunSimulationWithDelay(0,this._stepDelta,2e3)}stop(){this._state=ORG.RunnerState.IDLE}pause(){this._state=ORG.RunnerState.PAUSED}resume(){this._state=ORG.RunnerState.RUNNING,this._executeRunSimulationWithDelay(this._nextStepDistance,this._stepDelta,50)}_executeRunSimulationWithDelay(e,t,i){const o=this;setTimeout(function(){o._runSimulation(e,t)},i)}_runSimulation(e,t){if(e>this._itinerary.length)return;if(this._state==ORG.RunnerState.IDLE)return;if(this._state==ORG.RunnerState.PAUSED)return;this._itineraryLocation.distance=e;const i=this._itineraryLocation.location,o=this._itineraryLocation.elevation;this._broadcastLocation(i,null,o),ORG.dispatcher.dispatch({actionType:"itinerary-location-update",lat:i.lat(),lng:i.lng(),elevation:o}),this._nextStepDistance=e+t,this._nextStepDistance<=this._itinerary.length&&this._executeRunSimulationWithDelay(this._nextStepDistance,t,100)}}